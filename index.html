<!DOCTYPE html><html lang="zh-TW"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>客訴處理系統 - 雲端版</title>    <style>        * {            margin: 0;            padding: 0;            box-sizing: border-box;        }        body {            font-family: 'Microsoft JhengHei', Arial, sans-serif;            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            min-height: 100vh;            padding: 20px;        }        .container {            max-width: 1200px;            margin: 0 auto;        }        .header {            text-align: center;            margin-bottom: 30px;            color: white;        }        .header h1 {            font-size: 2.5rem;            margin-bottom: 10px;            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);        }        .nav-tabs {            display: flex;            background: white;            border-radius: 15px 15px 0 0;            box-shadow: 0 4px 20px rgba(0,0,0,0.1);            overflow: hidden;        }        .nav-tab {            flex: 1;            padding: 15px 20px;            text-align: center;            cursor: pointer;            background: #f8f9fa;            border: none;            font-size: 16px;            font-weight: bold;            color: #6c757d;            transition: all 0.3s ease;        }        .nav-tab.active {            background: linear-gradient(135deg, #667eea, #764ba2);            color: white;        }        .nav-tab:hover:not(.active) {            background: #e9ecef;        }        .tab-content {            background: white;            border-radius: 0 0 15px 15px;            box-shadow: 0 4px 20px rgba(0,0,0,0.1);            min-height: 500px;            display: none;        }        .tab-content.active {            display: block;        }        .form-container, .admin-container {            padding: 30px;        }        .form-group {            margin-bottom: 25px;        }        .form-group label {            display: block;            margin-bottom: 8px;            font-weight: bold;            color: #333;        }        .form-control {            width: 100%;            padding: 12px;            border: 2px solid #e9ecef;            border-radius: 8px;            font-size: 16px;            transition: all 0.3s ease;        }        .form-control:focus {            border-color: #667eea;            outline: none;            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);        }        textarea.form-control {            resize: vertical;            min-height: 120px;        }        .file-upload-area {            border: 2px dashed #667eea;            border-radius: 8px;            padding: 30px;            text-align: center;            background: #f8f9ff;            transition: all 0.3s ease;            cursor: pointer;        }        .file-upload-area:hover {            background: #f0f4ff;        }        .file-upload-area.dragover {            border-color: #4c63d2;            background: #e8efff;        }        .upload-icon {            font-size: 48px;            color: #667eea;            margin-bottom: 15px;        }        .btn {            padding: 12px 30px;            border: none;            border-radius: 8px;            font-size: 16px;            font-weight: bold;            cursor: pointer;            transition: all 0.3s ease;            margin: 5px;        }        .btn-primary {            background: linear-gradient(135deg, #667eea, #764ba2);            color: white;        }        .btn-primary:hover {            transform: translateY(-2px);            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);        }        .btn-success {            background: linear-gradient(135deg, #00b894, #00a085);            color: white;        }        .btn-warning {            background: linear-gradient(135deg, #fdcb6e, #e17055);            color: white;        }        .btn-danger {            background: linear-gradient(135deg, #ff6b6b, #ee5a52);            color: white;        }        .btn-info {            background: linear-gradient(135deg, #74b9ff, #0984e3);            color: white;        }        .complaint-list {            display: grid;            gap: 20px;        }        .complaint-item {            background: #f8f9fa;            border: 1px solid #dee2e6;            border-radius: 10px;            padding: 20px;            transition: all 0.3s ease;        }        .complaint-item:hover {            transform: translateY(-2px);            box-shadow: 0 5px 15px rgba(0,0,0,0.1);        }        .complaint-header {            display: flex;            justify-content: space-between;            align-items: center;            margin-bottom: 15px;            flex-wrap: wrap;        }        .complaint-id {            font-weight: bold;            color: #667eea;            font-size: 18px;        }        .complaint-date {            color: #6c757d;            font-size: 14px;        }        .status-badge {            padding: 4px 12px;            border-radius: 20px;            font-size: 12px;            font-weight: bold;            margin-left: auto;        }        .status-pending {            background: #ffeaa7;            color: #d63031;        }        .status-processing {            background: #74b9ff;            color: white;        }        .status-resolved {            background: #00b894;            color: white;        }        .complaint-content {            display: grid;            grid-template-columns: 1fr 1fr;            gap: 15px;            margin-bottom: 15px;        }        .complaint-field {            background: white;            padding: 10px;            border-radius: 5px;            border-left: 4px solid #667eea;        }        .field-label {            font-weight: bold;            color: #333;            font-size: 14px;            margin-bottom: 5px;        }        .field-value {            color: #666;        }        .image-preview {            display: flex;            gap: 10px;            flex-wrap: wrap;            margin-top: 10px;        }        .image-preview img {            width: 100px;            height: 100px;            object-fit: cover;            border-radius: 5px;            border: 2px solid #dee2e6;        }        .complaint-actions {            display: flex;            gap: 10px;            justify-content: flex-end;            flex-wrap: wrap;        }        .success-message, .error-message, .info-message {            padding: 15px;            border-radius: 8px;            margin-bottom: 20px;            display: none;        }        .success-message {            background: #d4edda;            border: 1px solid #c3e6cb;            color: #155724;        }        .error-message {            background: #f8d7da;            border: 1px solid #f5c6cb;            color: #721c24;        }        .info-message {            background: #d1ecf1;            border: 1px solid #bee5eb;            color: #0c5460;        }        .stats-grid {            display: grid;            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));            gap: 20px;            margin-bottom: 30px;        }        .stat-card {            background: linear-gradient(135deg, #667eea, #764ba2);            color: white;            padding: 20px;            border-radius: 10px;            text-align: center;        }        .stat-number {            font-size: 2rem;            font-weight: bold;            margin-bottom: 5px;        }        .stat-label {            font-size: 14px;            opacity: 0.9;        }        .config-section {            background: #f8f9fa;            border: 1px solid #dee2e6;            border-radius: 10px;            padding: 20px;            margin-bottom: 30px;        }        .config-section h3 {            color: #333;            margin-bottom: 20px;            border-bottom: 2px solid #667eea;            padding-bottom: 10px;        }        .type-list {            display: grid;            gap: 10px;            margin-bottom: 20px;        }        .type-item {            display: flex;            justify-content: space-between;            align-items: center;            background: white;            padding: 10px 15px;            border-radius: 5px;            border: 1px solid #dee2e6;        }        .loading-overlay {            position: fixed;            top: 0;            left: 0;            right: 0;            bottom: 0;            background: rgba(0,0,0,0.5);            display: none;            justify-content: center;            align-items: center;            z-index: 9999;        }        .loading-spinner {            background: white;            padding: 30px;            border-radius: 10px;            text-align: center;        }        .spinner {            border: 4px solid #f3f3f3;            border-top: 4px solid #667eea;            border-radius: 50%;            width: 50px;            height: 50px;            animation: spin 1s linear infinite;            margin: 0 auto 20px;        }        @keyframes spin {            0% { transform: rotate(0deg); }            100% { transform: rotate(360deg); }        }        .setup-guide {            background: #fff3cd;            border: 1px solid #ffeaa7;            color: #856404;            padding: 20px;            border-radius: 10px;            margin-bottom: 20px;        }        @media (max-width: 768px) {            .complaint-content {                grid-template-columns: 1fr;            }                        .nav-tab {                padding: 12px 15px;                font-size: 14px;            }                        .header h1 {                font-size: 2rem;            }            .complaint-actions {                justify-content: center;            }        }    </style>    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script></head><body>    <div class="loading-overlay" id="loading-overlay">        <div class="loading-spinner">            <div class="spinner"></div>            <p>處理中，請稍候...</p>        </div>    </div>    <div class="container">        <div class="header">            <h1>🚗 客訴處理系統 - 雲端版</h1>            <p>專業的客戶服務管理平台</p>        </div>        <div class="nav-tabs">            <button class="nav-tab active" onclick="switchTab('customer')">客戶申訴</button>            <button class="nav-tab" onclick="switchTab('admin')">後台管理</button>        </div>        <div id="customer-tab" class="tab-content active">            <div class="form-container">                <div id="customer-success-message" class="success-message">                    ✅ 您的客訴已成功提交至雲端！我們會盡快處理並回覆您。                </div>                <div id="customer-error-message" class="error-message">                    ❌ 提交失敗，請檢查網路連線或稍後再試。                </div>                <form id="complaint-form">                    <div class="form-group">                        <label for="customer-name">客戶姓名 *</label>                        <input type="text" id="customer-name" class="form-control" required>                    </div>                    <div class="form-group">                        <label for="customer-phone">聯絡電話 *</label>                        <input type="tel" id="customer-phone" class="form-control" required>                    </div>                    <div class="form-group">                        <label for="customer-email">電子信箱</label>                        <input type="email" id="customer-email" class="form-control">                    </div>                    <div class="form-group">                        <label for="license-plate">車牌號碼 *</label>                        <input type="text" id="license-plate" class="form-control" placeholder="例：ABC-1234" required>                    </div>                    <div class="form-group">                        <label for="complaint-type">客訴類型 *</label>                        <select id="complaint-type" class="form-control" required>                            <option value="">請選擇客訴類型</option>                            </select>                    </div>                    <div class="form-group">                        <label for="incident-date">事發日期 *</label>                        <input type="date" id="incident-date" class="form-control" required>                    </div>                    <div class="form-group">                        <label for="description">問題描述 *</label>                        <textarea id="description" class="form-control" placeholder="請詳細描述您遇到的問題..." required></textarea>                    </div>                    <div class="form-group">                        <label>上傳相關照片</label>                        <div class="file-upload-area" onclick="document.getElementById('photo-upload').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">                            <div class="upload-icon">📷</div>                            <p><strong>點擊上傳</strong> 或 <strong>拖拽照片至此</strong></p>                            <p style="font-size: 14px; color: #666; margin-top: 10px;">支援 JPG, PNG 格式，最大 5MB</p>                            <input type="file" id="photo-upload" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(event)">                        </div>                        <div id="image-preview" class="image-preview"></div>                    </div>                    <button type="submit" class="btn btn-primary">☁️ 提交客訴至雲端</button>                </form>            </div>        </div>        <div id="admin-tab" class="tab-content">            <div id="login-container" class="admin-container">                <div style="max-width: 400px; margin: 50px auto; text-align: center;">                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">                        <h2 style="margin-bottom: 10px;">🔐 管理員登入</h2>                        <p>請輸入帳號密碼以存取後台管理</p>                    </div>                                        <div id="login-error" class="error-message">                        帳號或密碼錯誤，請重新輸入                    </div>                                        <form id="login-form" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">                        <div class="form-group">                            <label for="admin-username">管理員帳號</label>                            <input type="text" id="admin-username" class="form-control" placeholder="請輸入帳號" required>                        </div>                        <div class="form-group">                            <label for="admin-password">密碼</label>                            <input type="password" id="admin-password" class="form-control" placeholder="請輸入密碼" required>                        </div>                        <button type="submit" class="btn btn-primary" style="width: 100%;">登入</button>                    </form>                                        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; font-size: 14px;">                        <strong>測試帳號：</strong><br>                        帳號：admin<br>                        密碼：123456                    </div>                </div>            </div>            <div id="admin-dashboard" class="admin-container" style="display: none;">                <div class="setup-guide">                    <h3>⚙️ Google Sheets API 設定</h3>                    <p><strong>重要：</strong>使用雲端功能前，請先設定 Google Sheets API 金鑰：</p>                    <div class="form-group" style="margin-top: 15px;">                        <label for="api-key">Google Sheets API 金鑰</label>                        <input type="text" id="api-key" class="form-control" placeholder="請輸入您的 API 金鑰">                    </div>                    <div class="form-group">                        <label for="sheet-id">Google 試算表 ID</label>                        <input type="text" id="sheet-id" class="form-control" placeholder="請輸入試算表 ID">                    </div>                    <button class="btn btn-info" onclick="saveGoogleSheetsConfig()">💾 儲存設定</button>                    <button class="btn btn-success" onclick="initializeSheet()">🚀 初始化試算表</button>                </div>                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap;">                    <h2 style="color: #333;">📊 後台管理系統</h2>                    <div>                        <button class="btn btn-success" onclick="exportToCSV()">📊 匯出 CSV</button>                        <button class="btn btn-info" onclick="syncFromCloud()">☁️ 同步雲端資料</button>                        <button class="btn btn-danger" onclick="logout()">登出</button>                    </div>                </div>                <div class="stats-grid">                    <div class="stat-card">                        <div class="stat-number" id="total-complaints">0</div>                        <div class="stat-label">總客訴數</div>                    </div>                    <div class="stat-card">                        <div class="stat-number" id="pending-complaints">0</div>                        <div class="stat-label">待處理</div>                    </div>                    <div class="stat-card">                        <div class="stat-number" id="processing-complaints">0</div>                        <div class="stat-label">處理中</div>                    </div>                    <div class="stat-card">                        <div class="stat-number" id="resolved-complaints">0</div>                        <div class="stat-label">已解決</div>                    </div>                </div>                <div class="config-section">                    <h3>🏷️ 客訴類型管理</h3>                    <div class="type-list" id="complaint-types-list">                        </div>                    <div style="display: flex; gap: 10px; align-items: end;">                        <div class="form-group" style="flex: 1; margin-bottom: 0;">                            <label for="new-type-value">類型代碼</label>                            <input type="text" id="new-type-value" class="form-control" placeholder="例：warranty">                        </div>                        <div class="form-group" style="flex: 2; margin-bottom: 0;">                            <label for="new-type-label">顯示名稱</label>                            <input type="text" id="new-type-label" class="form-control" placeholder="例：保固相關問題">                        </div>                        <button class="btn btn-success" onclick="addComplaintType()">➕ 新增類型</button>                    </div>                </div>                <h3 style="margin-bottom: 20px; color: #333;">客訴記錄列表</h3>                <div id="admin-info-message" class="info-message">                    💡 從雲端同步資料或等待客戶提交新申訴                </div>                <div id="complaint-list" class="complaint-list">                    </div>            </div>        </div>    </div>    <script>        // 全域變數        let complaints = JSON.parse(localStorage.getItem('complaints_backup')) || [];        let complaintIdCounter = parseInt(localStorage.getItem('complaintIdCounter')) || 1;        let isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';        let complaintTypes = JSON.parse(localStorage.getItem('complaintTypes')) || [            { value: 'service', label: '服務品質問題' },            { value: 'damage', label: '車輛損壞' },            { value: 'billing', label: '計費爭議' },            { value: 'staff', label: '員工服務態度' },            { value: 'facility', label: '設施設備問題' },            { value: 'safety', label: '安全相關問題' },            { value: 'appointment', label: '預約排程問題' },            { value: 'refund', label: '退款相關' },            { value: 'other', label: '其他問題' }        ];        // Google Sheets 設定        let googleSheetsConfig = JSON.parse(localStorage.getItem('googleSheetsConfig')) || {            apiKey: '',            sheetId: ''        };        // 管理員帳號設定        const adminCredentials = {            username: 'admin',            password: '123456'        };        // 初始化        document.addEventListener('DOMContentLoaded', function() {            checkAdminLogin();            loadComplaintTypes();            updateComplaintTypesList();            loadComplaintList();            updateStats();                        // 載入 Google Sheets 設定            if (googleSheetsConfig.apiKey && googleSheetsConfig.sheetId) {                document.getElementById('api-key').value = googleSheetsConfig.apiKey;                document.getElementById('sheet-id').value = googleSheetsConfig.sheetId;            }                        // 登入表單事件            const loginForm = document.getElementById('login-form');            if (loginForm) {                loginForm.addEventListener('submit', handleLogin);            }                        const complaintForm = document.getElementById('complaint-form');            if (complaintForm) {                complaintForm.addEventListener('submit', handleComplaintSubmit);            }        });        // 顯示載入動畫        function showLoading() {            document.getElementById('loading-overlay').style.display = 'flex';        }        // 隱藏載入動畫        function hideLoading() {            document.getElementById('loading-overlay').style.display = 'none';        }        // 切換頁籤        function switchTab(tabName) {            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));                        event.target.classList.add('active');            document.getElementById(tabName + '-tab').classList.add('active');                        if (tabName === 'admin') {                checkAdminLogin();                if (isAdminLoggedIn) {                    loadComplaintList();                    updateStats();                    updateComplaintTypesList();                }            } else if (tabName === 'customer') {                loadComplaintTypes();            }        }        // 載入客訴類型到下拉選單        function loadComplaintTypes() {            const select = document.getElementById('complaint-type');            select.innerHTML = '<option value="">請選擇客訴類型</option>';                        complaintTypes.forEach(type => {                const option = document.createElement('option');                option.value = type.value;                option.textContent = type.label;                select.appendChild(option);            });        }        // 更新後台的客訴類型列表        function updateComplaintTypesList() {            if (!isAdminLoggedIn) return;                        const list = document.getElementById('complaint-types-list');            list.innerHTML = '';                        complaintTypes.forEach((type, index) => {                const item = document.createElement('div');                item.className = 'type-item';                item.innerHTML = `                    <div>                        <strong>${type.value}</strong> - ${type.label}                    </div>                    <button class="btn btn-danger" onclick="removeComplaintType(${index})" style="padding: 5px 10px; margin: 0;">🗑️</button>                `;                list.appendChild(item);            });        }        // 新增客訴類型        function addComplaintType() {            const value = document.getElementById('new-type-value').value.trim();            const label = document.getElementById('new-type-label').value.trim();                        if (!value || !label) {                alert('請填寫完整的類型代碼和顯示名稱');                return;            }                        // 檢查是否重複            if (complaintTypes.find(type => type.value === value)) {                alert('類型代碼已存在，請使用其他代碼');                return;            }                        complaintTypes.push({ value, label });            localStorage.setItem('complaintTypes', JSON.stringify(complaintTypes));                        // 清空輸入框            document.getElementById('new-type-value').value = '';            document.getElementById('new-type-label').value = '';                        // 更新顯示            updateComplaintTypesList();            loadComplaintTypes();        }        // 刪除客訴類型        function removeComplaintType(index) {            if (confirm('確定要刪除這個客訴類型嗎？')) {                complaintTypes.splice(index, 1);                localStorage.setItem('complaintTypes', JSON.stringify(complaintTypes));                updateComplaintTypesList();                loadComplaintTypes();            }        }        // 儲存 Google Sheets 設定        function saveGoogleSheetsConfig() {            const apiKey = document.getElementById('api-key').value.trim();            const sheetId = document.getElementById('sheet-id').value.trim();                        if (!apiKey || !sheetId) {                alert('請填寫完整的 API 金鑰和試算表 ID');                return;            }                        googleSheetsConfig = { apiKey, sheetId };            localStorage.setItem('googleSheetsConfig', JSON.stringify(googleSheetsConfig));                        showMessage('success', '✅ Google Sheets 設定已儲存！');        }        // 初始化 Google Sheets        async function initializeSheet() {            if (!googleSheetsConfig.apiKey || !googleSheetsConfig.sheetId) {                alert('請先設定 API 金鑰和試算表 ID');                return;            }                        showLoading();                        try {                // 設定標題列                const headers = [                    '客訴編號', '提交時間', '客戶姓名', '聯絡電話', '電子信箱',                     '車牌號碼', '客訴類型', '事發日期', '問題描述', '處理狀態', '照片數量'                ];                                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${googleSheetsConfig.sheetId}/values/A1:K1?key=${googleSheetsConfig.apiKey}`, {                    method: 'PUT',                    headers: {                        'Content-Type': 'application/json'                    },                    body: JSON.stringify({                        values: [headers]                    })                });                                if (response.ok) {                    showMessage('success', '✅ Google Sheets 初始化成功！');                } else {                    throw new Error('初始化失敗');                }            } catch (error) {                console.error('初始化錯誤:', error);                showMessage('error', '❌ 初始化失敗，請檢查 API 金鑰和試算表 ID');            } finally {                hideLoading();            }        }        // 同步資料到 Google Sheets        async function syncToGoogleSheets(complaintData) {            if (!googleSheetsConfig.apiKey || !googleSheetsConfig.sheetId) {                return false;            }                        try {                const rowData = [                    complaintData.id.toString().padStart(4, '0'),                    new Date(complaintData.submitDate).toLocaleString('zh-TW'),                    complaintData.customerName,                    complaintData.customerPhone,                    complaintData.customerEmail || '',                    complaintData.licensePlate,                    getComplaintTypeText(complaintData.complaintType),                    complaintData.incidentDate,                    complaintData.description,                    getStatusText(complaintData.status),                    (complaintData.images ? complaintData.images.length : 0).toString()                ];                                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${googleSheetsConfig.sheetId}/values/A:K:append?valueInputOption=USER_ENTERED&key=${googleSheetsConfig.apiKey}`, {                    method: 'POST',                    headers: {                        'Content-Type': 'application/json'                    },                    body: JSON.stringify({                        values: [rowData]                    })                });                                return response.ok;            } catch (error) {                console.error('同步到 Google Sheets 失敗:', error);                return false;            }        }        // 從 Google Sheets 同步資料        async function syncFromCloud() {            if (!googleSheetsConfig.apiKey || !googleSheetsConfig.sheetId) {                alert('請先設定 Google Sheets API 金鑰和試算表 ID');                return;            }                        showLoading();                        try {                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${googleSheetsConfig.sheetId}/values/A2:K?key=${googleSheetsConfig.apiKey}`);                                if (response.ok) {                    const data = await response.json();                    if (data.values && data.values.length > 0) {                        complaints = data.values.map((row, index) => ({                            id: parseInt(row[0]) || index + 1,                            submitDate: row[1] || new Date().toISOString(),                            customerName: row[2] || '',                            customerPhone: row[3] || '',                            customerEmail: row[4] || '',                            licensePlate: row[5] || '',                            complaintType: getComplaintTypeValue(row[6]) || 'other',                            incidentDate: row[7] || '',                            description: row[8] || '',                            status: getStatusValue(row[9]) || 'pending',                            images: []                        }));                                                localStorage.setItem('complaints_backup', JSON.stringify(complaints));                        loadComplaintList();                        updateStats();                        showMessage('success', `✅ 成功同步 ${complaints.length} 筆資料！`);                    } else {                        showMessage('info', '📋 雲端暫無資料');                    }                } else {                    throw new Error('同步失敗');                }            } catch (error) {                console.error('同步錯誤:', error);                showMessage('error', '❌ 同步失敗，請檢查網路連線和設定');            } finally {                hideLoading();            }        }        // 匯出 CSV 檔案        function exportToCSV() {            if (complaints.length === 0) {                alert('目前沒有資料可以匯出');                return;            }                        const headers = [                '客訴編號', '提交時間', '客戶姓名', '聯絡電話', '電子信箱',                 '車牌號碼', '客訴類型', '事發日期', '問題描述', '處理狀態', '照片數量'            ];                        const csvData = complaints.map(complaint => [                complaint.id.toString().padStart(4, '0'),                new Date(complaint.submitDate).toLocaleString('zh-TW'),                complaint.customerName,                complaint.customerPhone,                complaint.customerEmail || '',                complaint.licensePlate,                getComplaintTypeText(complaint.complaintType),                complaint.incidentDate,                `"${complaint.description.replace(/"/g, '""')}"`, // 處理描述中的引號                getStatusText(complaint.status),                (complaint.images ? complaint.images.length : 0)            ]);                        const csvContent = [headers, ...csvData]                .map(row => row.join(','))                .join('\n');                        // 加上 BOM 以支援中文            const BOM = '\uFEFF';            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });            const link = document.createElement("a");            const url = URL.createObjectURL(blob);            link.setAttribute("href", url);            link.setAttribute("download", `客訴記錄_${new Date().toISOString().slice(0, 10)}.csv`);            link.style.visibility = 'hidden';            document.body.appendChild(link);            link.click();            document.body.removeChild(link);        }        // 登入處理        function handleLogin(event) {            event.preventDefault();            const username = document.getElementById('admin-username').value;            const password = document.getElementById('admin-password').value;            const loginError = document.getElementById('login-error');                        if (username === adminCredentials.username && password === adminCredentials.password) {                sessionStorage.setItem('adminLoggedIn', 'true');                isAdminLoggedIn = true;                checkAdminLogin();                loginError.style.display = 'none';                // 切換到後台介面後，自動載入資料                syncFromCloud();            } else {                loginError.style.display = 'block';            }        }        // 檢查登入狀態並切換介面        function checkAdminLogin() {            const loginContainer = document.getElementById('login-container');            const adminDashboard = document.getElementById('admin-dashboard');                        if (isAdminLoggedIn) {                loginContainer.style.display = 'none';                adminDashboard.style.display = 'block';            } else {                loginContainer.style.display = 'block';                adminDashboard.style.display = 'none';            }        }        // 登出功能        function logout() {            sessionStorage.removeItem('adminLoggedIn');            isAdminLoggedIn = false;            checkAdminLogin();            alert('您已登出');        }        // 表單提交處理        async function handleComplaintSubmit(event) {            event.preventDefault();            showLoading();            const form = event.target;            const newComplaint = {                id: complaintIdCounter++,                customerName: form['customer-name'].value,                customerPhone: form['customer-phone'].value,                customerEmail: form['customer-email'].value,                licensePlate: form['license-plate'].value,                complaintType: form['complaint-type'].value,                incidentDate: form['incident-date'].value,                description: form['description'].value,                submitDate: new Date().toISOString(),                status: 'pending',                images: []            };                        // 讀取圖片檔案並轉換為 Base64            const files = document.getElementById('photo-upload').files;            const promises = Array.from(files).map(file => {                return new Promise((resolve, reject) => {                    const reader = new FileReader();                    reader.onload = e => resolve(e.target.result);                    reader.onerror = e => reject(e);                    reader.readAsDataURL(file);                });            });                        try {                newComplaint.images = await Promise.all(promises);                complaints.push(newComplaint);                localStorage.setItem('complaints_backup', JSON.stringify(complaints));                localStorage.setItem('complaintIdCounter', complaintIdCounter);                form.reset();                document.getElementById('image-preview').innerHTML = '';                                const success = await syncToGoogleSheets(newComplaint);                                if (success) {                    showMessage('success', '✅ 您的客訴已成功提交至雲端！我們會盡快處理並回覆您。');                } else {                    showMessage('info', '💡 您的客訴已本地保存，但未能同步至雲端，請檢查設定或網路。');                }            } catch (error) {                console.error('圖片處理或提交失敗:', error);                showMessage('error', '❌ 提交失敗，請檢查網路連線或稍後再試。');            } finally {                hideLoading();            }        }        // 檔案上傳預覽處理        function handleFileSelect(event) {            const files = event.target.files;            displayImagePreviews(files);        }        function handleDragOver(event) {            event.preventDefault();            document.querySelector('.file-upload-area').classList.add('dragover');        }        function handleDragLeave(event) {            event.preventDefault();            document.querySelector('.file-upload-area').classList.remove('dragover');        }        function handleDrop(event) {            event.preventDefault();            document.querySelector('.file-upload-area').classList.remove('dragover');            const files = event.dataTransfer.files;            document.getElementById('photo-upload').files = files; // 將拖曳的檔案賦予 input            displayImagePreviews(files);        }        function displayImagePreviews(files) {            const previewContainer = document.getElementById('image-preview');            previewContainer.innerHTML = '';            if (files) {                Array.from(files).forEach(file => {                    if (file.type.startsWith('image/')) {                        const reader = new FileReader();                        reader.onload = e => {                            const img = document.createElement('img');                            img.src = e.target.result;                            previewContainer.appendChild(img);                        };                        reader.readAsDataURL(file);                    }                });            }        }        // 載入客訴列表到後台        function loadComplaintList() {            if (!isAdminLoggedIn) return;            const listContainer = document.getElementById('complaint-list');            listContainer.innerHTML = '';            if (complaints.length === 0) {                document.getElementById('admin-info-message').style.display = 'block';                return;            }            document.getElementById('admin-info-message').style.display = 'none';            complaints.slice().reverse().forEach(complaint => { // 反轉以顯示最新提交的項目                const item = document.createElement('div');                item.className = 'complaint-item';                const statusBadge = `<span class="status-badge status-${complaint.status}">${getStatusText(complaint.status)}</span>`;                const typeText = getComplaintTypeText(complaint.complaintType);                item.innerHTML = `                    <div class="complaint-header">                        <span class="complaint-id">#${complaint.id.toString().padStart(4, '0')}</span>                        <span class="complaint-date">${new Date(complaint.submitDate).toLocaleString('zh-TW')}</span>                        ${statusBadge}                    </div>                    <div class="complaint-content">                        <div class="complaint-field">                            <div class="field-label">客戶姓名</div>                            <div class="field-value">${complaint.customerName}</div>                        </div>                        <div class="complaint-field">                            <div class="field-label">聯絡電話</div>                            <div class="field-value">${complaint.customerPhone}</div>                        </div>                        <div class="complaint-field">                            <div class="field-label">車牌號碼</div>                            <div class="field-value">${complaint.licensePlate}</div>                        </div>                        <div class="complaint-field">                            <div class="field-label">客訴類型</div>                            <div class="field-value">${typeText}</div>                        </div>                        <div class="complaint-field" style="grid-column: span 2;">                            <div class="field-label">問題描述</div>                            <div class="field-value">${complaint.description}</div>                        </div>                    </div>                    <div id="image-previews-${complaint.id}" class="image-preview"></div>                    <div class="complaint-actions">                        <select onchange="updateStatus(${complaint.id}, this.value)" class="form-control" style="width: auto; flex-grow: 1;">                            <option value="pending" ${complaint.status === 'pending' ? 'selected' : ''}>待處理</option>                            <option value="processing" ${complaint.status === 'processing' ? 'selected' : ''}>處理中</option>                            <option value="resolved" ${complaint.status === 'resolved' ? 'selected' : ''}>已解決</option>                        </select>                        <button class="btn btn-warning" onclick="editComplaint(${complaint.id})">編輯</button>                        <button class="btn btn-danger" onclick="deleteComplaint(${complaint.id})">刪除</button>                    </div>                `;                listContainer.appendChild(item);                // 顯示圖片預覽                const imagePreviewContainer = document.getElementById(`image-previews-${complaint.id}`);                if (complaint.images && complaint.images.length > 0) {                    complaint.images.forEach(base64Image => {                        const img = document.createElement('img');                        img.src = base64Image;                        imagePreviewContainer.appendChild(img);                    });                }            });        }        // 更新客訴狀態        function updateStatus(id, newStatus) {            const complaintIndex = complaints.findIndex(c => c.id === id);            if (complaintIndex !== -1) {                complaints[complaintIndex].status = newStatus;                localStorage.setItem('complaints_backup', JSON.stringify(complaints));                loadComplaintList();                updateStats();                // 未來可加入同步至雲端的功能            }        }        // 刪除客訴        function deleteComplaint(id) {            if (confirm('確定要刪除這筆客訴記錄嗎？')) {                complaints = complaints.filter(c => c.id !== id);                localStorage.setItem('complaints_backup', JSON.stringify(complaints));                loadComplaintList();                updateStats();                // 未來可加入同步至雲端的功能            }        }        // 更新統計數字        function updateStats() {            if (!isAdminLoggedIn) return;            const total = complaints.length;            const pending = complaints.filter(c => c.status === 'pending').length;            const processing = complaints.filter(c => c.status === 'processing').length;            const resolved = complaints.filter(c => c.status === 'resolved').length;            document.getElementById('total-complaints').textContent = total;            document.getElementById('pending-complaints').textContent = pending;            document.getElementById('processing-complaints').textContent = processing;            document.getElementById('resolved-complaints').textContent = resolved;        }        // 顯示訊息框        function showMessage(type, message) {            const successMsg = document.getElementById('customer-success-message');            const errorMsg = document.getElementById('customer-error-message');            const infoMsg = document.getElementById('admin-info-message');            successMsg.style.display = 'none';            errorMsg.style.display = 'none';            infoMsg.style.display = 'none';                        if (type === 'success') {                successMsg.textContent = message;                successMsg.style.display = 'block';            } else if (type === 'error') {                errorMsg.textContent = message;                errorMsg.style.display = 'block';            } else if (type === 'info') {                infoMsg.textContent = message;                infoMsg.style.display = 'block';            }        }        // 輔助函數：取得客訴類型文字        function getComplaintTypeText(value) {            const type = complaintTypes.find(t => t.value === value);            return type ? type.label : value;        }        // 輔助函數：取得客訴類型代碼        function getComplaintTypeValue(label) {            const type = complaintTypes.find(t => t.label === label);            return type ? type.value : label;        }        // 輔助函數：取得狀態文字        function getStatusText(status) {            const statusMap = {                pending: '待處理',                processing: '處理中',                resolved: '已解決'            };            return statusMap[status] || status;        }        // 輔助函數：取得狀態代碼        function getStatusValue(statusText) {            const statusMap = {                '待處理': 'pending',                '處理中': 'processing',                '已解決': 'resolved'            };            return statusMap[statusText] || statusText;        }    </script></body></html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客訴處理系統 - 雲端版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 500px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-container, .admin-container {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            background: #f0f4ff;
        }

        .file-upload-area.dragover {
            border-color: #4c63d2;
            background: #e8efff;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .complaint-list {
            display: grid;
            gap: 20px;
        }

        .complaint-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .complaint-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .complaint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .complaint-id {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .complaint-date {
            color: #6c757d;
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: auto;
        }

        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-processing {
            background: #74b9ff;
            color: white;
        }

        .status-resolved {
            background: #00b894;
            color: white;
        }

        .complaint-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .complaint-field {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .field-label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .field-value {
            color: #666;
        }

        .image-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #dee2e6;
        }

        .complaint-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .success-message, .error-message, .info-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .config-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .type-list {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .setup-guide {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .complaint-content {
                grid-template-columns: 1fr;
            }
            
            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .complaint-actions {
                justify-content: center;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>處理中，請稍候...</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🚗 客訴處理系統 - 雲端版</h1>
            <p>專業的客戶服務管理平台</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('customer')">客戶申訴</button>
            <button class="nav-tab" onclick="switchTab('admin')">後台管理</button>
        </div>

        <!-- 客戶申訴表單 -->
        <div id="customer-tab" class="tab-content active">
            <div class="form-container">
                <div id="customer-success-message" class="success-message">
                    ✅ 您的客訴已成功提交至雲端！我們會盡快處理並回覆您。
                </div>

                <div id="customer-error-message" class="error-message">
                    ❌ 提交失敗，請檢查網路連線或稍後再試。
                </div>

                <form id="complaint-form">
                    <div class="form-group">
                        <label for="customer-name">客戶姓名 *</label>
                        <input type="text" id="customer-name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="customer-phone">聯絡電話 *</label>
                        <input type="tel" id="customer-phone" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="customer-email">電子信箱</label>
                        <input type="email" id="customer-email" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="license-plate">車牌號碼 *</label>
                        <input type="text" id="license-plate" class="form-control" placeholder="例：ABC-1234" required>
                    </div>

                    <div class="form-group">
                        <label for="complaint-type">客訴類型 *</label>
                        <select id="complaint-type" class="form-control" required>
                            <option value="">請選擇客訴類型</option>
                            <!-- 動態載入選項 -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="incident-date">事發日期 *</label>
                        <input type="date" id="incident-date" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="description">問題描述 *</label>
                        <textarea id="description" class="form-control" placeholder="請詳細描述您遇到的問題..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>上傳相關照片</label>
                        <div class="file-upload-area" onclick="document.getElementById('photo-upload').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="upload-icon">📷</div>
                            <p><strong>點擊上傳</strong> 或 <strong>拖拽照片至此</strong></p>
                            <p style="font-size: 14px; color: #666; margin-top: 10px;">支援 JPG, PNG 格式，最大 5MB</p>
                            <input type="file" id="photo-upload" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                        <div id="image-preview" class="image-preview"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">☁️ 提交客訴至雲端</button>
                </form>
            </div>
        </div>

        <!-- 後台管理 -->
        <div id="admin-tab" class="tab-content">
            <!-- 登入頁面 -->
            <div id="login-container" class="admin-container">
                <div style="max-width: 400px; margin: 50px auto; text-align: center;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h2 style="margin-bottom: 10px;">🔐 管理員登入</h2>
                        <p>請輸入帳號密碼以存取後台管理</p>
                    </div>
                    
                    <div id="login-error" class="error-message">
                        帳號或密碼錯誤，請重新輸入
                    </div>
                    
                    <form id="login-form" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        <div class="form-group">
                            <label for="admin-username">管理員帳號</label>
                            <input type="text" id="admin-username" class="form-control" placeholder="請輸入帳號" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-password">密碼</label>
                            <input type="password" id="admin-password" class="form-control" placeholder="請輸入密碼" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">登入</button>
                    </form>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; font-size: 14px;">
                        <strong>測試帳號：</strong><br>
                        帳號：admin<br>
                        密碼：123456
                    </div>
                </div>
            </div>

            <!-- 管理介面 -->
            <div id="admin-dashboard" class="admin-container" style="display: none;">
                <!-- Google Sheets 設定 -->
                <div class="setup-guide">
                    <h3>⚙️ Google Sheets API 設定</h3>
                    <p><strong>重要：</strong>使用雲端功能前，請先設定 Google Sheets API 金鑰：</p>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="api-key">Google Sheets API 金鑰</label>
                        <input type="text" id="api-key" class="form-control" placeholder="請輸入您的 API 金鑰">
                    </div>
                    <div class="form-group">
                        <label for="sheet-id">Google 試算表 ID</label>
                        <input type="text" id="sheet-id" class="form-control" placeholder="請輸入試算表 ID">
                    </div>
                    <button class="btn btn-info" onclick="saveGoogleSheetsConfig()">💾 儲存設定</button>
                    <button class="btn btn-success" onclick="initializeSheet()">🚀 初始化試算表</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap;">
                    <h2 style="color: #333;">📊 後台管理系統</h2>
                    <div>
                        <button class="btn btn-success" onclick="exportToCSV()">📊 匯出 CSV</button>
                        <button class="btn btn-info" onclick="syncFromCloud()">☁️ 同步雲端資料</button>
                        <button class="btn btn-danger" onclick="logout()">登出</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-complaints">0</div>
                        <div class="stat-label">總客訴數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-complaints">0</div>
                        <div class="stat-label">待處理</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="processing-complaints">0</div>
                        <div class="stat-label">處理中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="resolved-complaints">0</div>
                        <div class="stat-label">已解決</div>
                    </div>
                </div>

                <!-- 客訴類型管理 -->
                <div class="config-section">
                    <h3>🏷️ 客訴類型管理</h3>
                    <div class="type-list" id="complaint-types-list">
                        <!-- 動態載入 -->
                    </div>
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label for="new-type-value">類型代碼</label>
                            <input type="text" id="new-type-value" class="form-control" placeholder="例：warranty">
                        </div>
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <label for="new-type-label">顯示名稱</label>
                            <input type="text" id="new-type-label" class="form-control" placeholder="例：保固相關問題">
                        </div>
                        <button class="btn btn-success" onclick="addComplaintType()">➕ 新增類型</button>
                    </div>
                </div>

                <h3 style="margin-bottom: 20px; color: #333;">客訴記錄列表</h3>
                <div id="admin-info-message" class="info-message">
                    💡 從雲端同步資料或等待客戶提交新申訴
                </div>
                <div id="complaint-list" class="complaint-list">
                    <!-- 客訴記錄會動態顯示在這裡 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let complaints = JSON.parse(localStorage.getItem('complaints_backup')) || [];
        let complaintIdCounter = parseInt(localStorage.getItem('complaintIdCounter')) || 1;
        let isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
        let complaintTypes = JSON.parse(localStorage.getItem('complaintTypes')) || [
            { value: 'service', label: '服務品質問題' },
            { value: 'damage', label: '車輛損壞' },
            { value: 'billing', label: '計費爭議' },
            { value: 'staff', label: '員工服務態度' },
            { value: 'facility', label: '設施設備問題' },
            { value: 'safety', label: '安全相關問題' },
            { value: 'appointment', label: '預約排程問題' },
            { value: 'refund', label: '退款相關' },
            { value: 'other', label: '其他問題' }
        ];

        // Google Sheets 設定
        let googleSheetsConfig = JSON.parse(localStorage.getItem('googleSheetsConfig')) || {
            apiKey: '',
            sheetId: ''
        };

        // 管理員帳號設定
        const adminCredentials = {
            username: 'admin',
            password: '123456'
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminLogin();
            loadComplaintTypes();
            updateComplaintTypesList();
            loadComplaintList();
            updateStats();
            
            // 載入 Google Sheets 設定
            if (googleSheetsConfig.apiKey && googleSheetsConfig.sheetId) {
                document.getElementById('api-key').value = googleSheetsConfig.apiKey;
                document.getElementById('sheet-id').value = googleSheetsConfig.sheetId;
            }
            
            // 登入表單事件
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            const complaintForm = document.getElementById('complaint-form');
            if (complaintForm) {
                complaintForm.addEventListener('submit', handleComplaintSubmit);
            }
        });

        // 顯示載入動畫
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        // 隱藏載入動畫
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // 切換頁籤
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'admin') {
                checkAdminLogin();
                if (isAdminLoggedIn) {
                    loadComplaintList();
                    updateStats();
                    updateComplaintTypesList();
                }
            } else if (tabName === 'customer') {
                loadComplaintTypes();
            }
        }

        // 載入客訴類型到下拉選單
        function loadComplaintTypes() {
            const select = document.getElementById('complaint-type');
            select.innerHTML = '<option value="">請選擇客訴類型</option>';
            
            complaintTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.value;
                option.textContent = type.label;
                select.appendChild(option);
            });
        }

        // 更新後台的客訴類型列表
        function updateComplaintTypesList() {
            if (!isAdminLoggedIn) return;
            
            const list = document.getElementById('complaint-types-list');
            list.innerHTML = '';
            
            complaintTypes.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'type-item';
                item.innerHTML = `
                    <div>
                        <strong>${type.value}</strong> - ${type.label}
                    </div>
                    <button class="btn btn-danger" onclick="removeComplaintType(${index})" style="padding: 5px 10px; margin: 0;">🗑️</button>
                `;
                list.appendChild(item);
            });
        }

        // 新增客訴類型
        function addComplaintType() {
            const value = document.getElementById('new-type-value').value.trim();
            const label = document.getElementById('new-type-label').value.trim();
            
            if (!value || !label) {
                alert('請填寫完整的類型代碼和顯示名稱');
                return;
            }
            
            // 檢查是否重複
            if (complaintTypes.find(type => type.value === value)) {
                alert('類型代碼已存在，請使用其他代碼');
                return;
            }
            
            complaintTypes.push({ value, label });
            localStorage.setItem('complaintTypes', JSON.stringify(complaintTypes));
            
            // 清空輸入框
            document.getElementById('new-type-value').value = '';
            document.getElementById('new-type-label').value = '';
            
            // 更新顯示
            updateComplaintTypesList();
            loadComplaintTypes();
        }

        // 刪除客訴類型
        function removeComplaintType(index) {
            if (confirm('確定要刪除這個客訴類型嗎？')) {
                complaintTypes.splice(index, 1);
                localStorage.setItem('complaintTypes', JSON.stringify(complaintTypes));
                updateComplaintTypesList();
                loadComplaintTypes();
            }
        }

        // 儲存 Google Sheets 設定
        function saveGoogleSheetsConfig() {
            const apiKey = document.getElementById('api-key').value.trim();
            const sheetId = document.getElementById('sheet-id').value.trim();
            
            if (!apiKey || !sheetId) {
                alert('請填寫完整的 API 金鑰和試算表 ID');
                return;
            }
            
            googleSheetsConfig = { apiKey, sheetId };
            localStorage.setItem('googleSheetsConfig', JSON.stringify(googleSheetsConfig));
            
            showMessage('success', '✅ Google Sheets 設定已儲存！');
        }

        // 初始化 Google Sheets
        async function initializeSheet() {
            if (!googleSheetsConfig.apiKey || !googleSheetsConfig.sheetId) {
                alert('請先設定 API 金鑰和試算表 ID');
                return;
            }
            
            showLoading();
            
            try {
                // 設定標題列
                const headers = [
                    '客訴編號', '提交時間', '客戶姓名', '聯絡電話', '電子信箱', 
                    '車牌號碼', '客訴類型', '事發日期', '問題描述', '處理狀態', '照片數量'
                ];
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${googleSheetsConfig.sheetId}/values/A1:K1?key=${googleSheetsConfig.apiKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [headers]
                    })
                });
                
                if (response.ok) {
                    showMessage('success', '✅ Google Sheets 初始化成功！');
                } else {
                    throw new Error('初始化失敗');
                }
            } catch (error) {
                console.error('初始化錯誤:', error);
                showMessage('error', '❌ 初始化失敗，請檢查 API 金鑰和試算表 ID');
            } finally {
                hideLoading();
            }
        }

        // 同步資料到 Google Sheets
        async function syncToGoogleSheets(complaintData) {
            if (!googleSheetsConfig.apiKey || !googleSheetsConfig.sheetId) {
                return false;
            }
            
            try {
                const rowData = [
                    complaintData.id.toString().padStart(4, '0'),
                    new Date(complaintData.submitDate).toLocaleString('zh-TW'),
                    complaintData.customerName,
                    complaintData.customerPhone,
                    complaintData.customerEmail || '',
                    complaintData.licensePlate,
                    getComplaintTypeText(complaintData.complaintType),
                    complaintData.incidentDate,
                    complaintData.description,
                    getStatusText(complaintData.status),
                    (complaintData.images ? complaintData.images.length : 0).toString()
                ];
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${googleSheetsConfig.sheetId}/values/A:K:append?valueInputOption=USER_ENTERED&key=${googleSheetsConfig.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [rowData]
                    })
                });
                
                return response.ok;
            } catch (error) {
                console.error('同步到 Google Sheets 失敗:', error);
                return false;
            }
        }

        // 從 Google Sheets 同步資料
        async function syncFromCloud() {
            if (!googleSheetsConfig.apiKey || !googleSheetsConfig.sheetId) {
                alert('請先設定 Google Sheets API 金鑰和試算表 ID');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${googleSheetsConfig.sheetId}/values/A2:K?key=${googleSheetsConfig.apiKey}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.values && data.values.length > 0) {
                        complaints = data.values.map((row, index) => ({
                            id: parseInt(row[0]) || index + 1,
                            submitDate: row[1] || new Date().toISOString(),
                            customerName: row[2] || '',
                            customerPhone: row[3] || '',
                            customerEmail: row[4] || '',
                            licensePlate: row[5] || '',
                            complaintType: getComplaintTypeValue(row[6]) || 'other',
                            incidentDate: row[7] || '',
                            description: row[8] || '',
                            status: getStatusValue(row[9]) || 'pending',
                            images: []
                        }));
                        
                        localStorage.setItem('complaints_backup', JSON.stringify(complaints));
                        loadComplaintList();
                        updateStats();
                        showMessage('success', `✅ 成功同步 ${complaints.length} 筆資料！`);
                    } else {
                        showMessage('info', '📋 雲端暫無資料');
                    }
                } else {
                    throw new Error('同步失敗');
                }
            } catch (error) {
                console.error('同步錯誤:', error);
                showMessage('error', '❌ 同步失敗，請檢查網路連線和設定');
            } finally {
                hideLoading();
            }
        }

        // 匯出 CSV 檔案
        function exportToCSV() {
            if (complaints.length === 0) {
                alert('目前沒有資料可以匯出');
                return;
            }
            
            const headers = [
                '客訴編號', '提交時間', '客戶姓名', '聯絡電話', '電子信箱', 
                '車牌號碼', '客訴類型', '事發日期', '問題描述', '處理狀態', '照片數量'
            ];
            
            const csvData = complaints.map(complaint => [
                complaint.id.toString().padStart(4, '0'),
                new Date(complaint.submitDate).toLocaleString('zh-TW'),
                complaint.customerName,
                complaint.customerPhone,
                complaint.customerEmail || '',
                complaint.licensePlate,
                getComplaintTypeText(complaint.complaintType),
                complaint.incidentDate,
                `"${complaint.description.replace(/"/g, '""')}"`, // 處理描述中的引號
                getStatusText(complaint.status),
                (complaint.images ? complaint.images.length : 0)
            ]);
            
            const csvContent = [headers, ...csvData]
                .map(row => row.join(','))
                .join('\n');
            
            // 加上 BOM 以支援中文
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `客訴資料_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage('success', '📊 CSV 檔案匯出成功！');
        }

        // 檢查管理員登入狀態
        function checkAdminLogin() {
            if (isAdminLoggedIn) {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
            } else {
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('admin-dashboard').style.display = 'none';
            }
        }

        // 處理登入
        function handleLogin(e) {
            e.preventDefault();
            console.log('登入嘗試開始');
            
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            
            console.log('帳號:', username, '密碼:', password);
            console.log('正確帳號:', adminCredentials.username, '正確密碼:', adminCredentials.password);
            
            if (username === adminCredentials.username && password === adminCredentials.password) {
                console.log('登入成功');
                isAdminLoggedIn = true;
                sessionStorage.setItem('adminLoggedIn', 'true');
                
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                document.getElementById('login-error').style.display = 'none';
                
                loadComplaintList();
                updateStats();
                updateComplaintTypesList();
                
                document.getElementById('login-form').reset();
                showMessage('info', '✅ 登入成功！');
            } else {
                console.log('登入失敗');
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('admin-password').value = '';
                showMessage('error', '❌ 帳號或密碼錯誤');
            }
        }

        // 登出功能
        function logout() {
            if (confirm('確定要登出嗎？')) {
                isAdminLoggedIn = false;
                sessionStorage.removeItem('adminLoggedIn');
                
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('login-form').reset();
                document.getElementById('login-error').style.display = 'none';
            }
        }

        // 處理檔案選擇
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            displayImages(files);
        }

        // 處理拖拽
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.target.closest('.file-upload-area').classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            displayImages(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.target.closest('.file-upload-area').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.target.closest('.file-upload-area').classList.remove('dragover');
        }

        // 顯示圖片預覽
        function displayImages(files) {
            const preview = document.getElementById('image-preview');
            
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`檔案 ${file.name} 大小超過 5MB，請重新選擇。`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.title = file.name;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // 表單提交
        async function handleComplaintSubmit(e) {
            e.preventDefault();
            
            showLoading();
            
            const formData = {
                id: complaintIdCounter++,
                customerName: document.getElementById('customer-name').value,
                customerPhone: document.getElementById('customer-phone').value,
                customerEmail: document.getElementById('customer-email').value,
                licensePlate: document.getElementById('license-plate').value,
                complaintType: document.getElementById('complaint-type').value,
                incidentDate: document.getElementById('incident-date').value,
                description: document.getElementById('description').value,
                images: Array.from(document.getElementById('image-preview').querySelectorAll('img')).map(img => img.src),
                submitDate: new Date().toISOString(),
                status: 'pending'
            };
            
            // 儲存到本機備份
            complaints.push(formData);
            localStorage.setItem('complaints_backup', JSON.stringify(complaints));
            localStorage.setItem('complaintIdCounter', complaintIdCounter.toString());
            
            // 嘗試同步到 Google Sheets
            const syncSuccess = await syncToGoogleSheets(formData);
            
            hideLoading();
            
            if (syncSuccess) {
                showMessage('customer-success', '✅ 您的客訴已成功提交至雲端！我們會盡快處理並回覆您。');
            } else {
                showMessage('customer-success', '✅ 您的客訴已成功提交！我們會盡快處理並回覆您。');
                console.log('雲端同步失敗，資料已儲存在本機備份');
            }
            
            // 清空表單
            document.getElementById('complaint-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            
            // 滾動到頂部
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // 顯示訊息
        function showMessage(type, message) {
            const messageElement = document.getElementById(type + '-message') || document.getElementById(type);
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }

        // 載入客訴列表
        function loadComplaintList() {
            if (!isAdminLoggedIn) return;
            
            const list = document.getElementById('complaint-list');
            list.innerHTML = '';
            
            if (complaints.length === 0) {
                document.getElementById('admin-info-message').style.display = 'block';
                return;
            } else {
                document.getElementById('admin-info-message').style.display = 'none';
            }
            
            complaints.sort((a, b) => new Date(b.submitDate) - new Date(a.submitDate)).forEach(complaint => {
                const item = createComplaintItem(complaint);
                list.appendChild(item);
            });
        }

        // 建立客訴項目
        function createComplaintItem(complaint) {
            const item = document.createElement('div');
            item.className = 'complaint-item';
            
            const statusClass = `status-${complaint.status}`;
            const statusText = getStatusText(complaint.status);
            const complaintTypeText = getComplaintTypeText(complaint.complaintType);
            
            item.innerHTML = `
                <div class="complaint-header">
                    <div>
                        <div class="complaint-id">客訴編號: #${complaint.id.toString().padStart(4, '0')}</div>
                        <div class="complaint-date">${new Date(complaint.submitDate).toLocaleString('zh-TW')}</div>
                    </div>
                    <div class="status-badge ${statusClass}">${statusText}</div>
                </div>
                
                <div class="complaint-content">
                    <div class="complaint-field">
                        <div class="field-label">客戶姓名</div>
                        <div class="field-value">${complaint.customerName}</div>
                    </div>
                    <div class="complaint-field">
                        <div class="field-label">聯絡電話</div>
                        <div class="field-value">${complaint.customerPhone}</div>
                    </div>
                    <div class="complaint-field">
                        <div class="field-label">車牌號碼</div>
                        <div class="field-value">${complaint.licensePlate}</div>
                    </div>
                    <div class="complaint-field">
                        <div class="field-label">客訴類型</div>
                        <div class="field-value">${complaintTypeText}</div>
                    </div>
                    <div class="complaint-field">
                        <div class="field-label">事發日期</div>
                        <div class="field-value">${complaint.incidentDate}</div>
                    </div>
                    <div class="complaint-field">
                        <div class="field-label">電子信箱</div>
                        <div class="field-value">${complaint.customerEmail || '未提供'}</div>
                    </div>
                </div>
                
                <div class="complaint-field">
                    <div class="field-label">問題描述</div>
                    <div class="field-value">${complaint.description}</div>
                    ${complaint.images && complaint.images.length > 0 ? `
                        <div class="image-preview">
                            ${complaint.images.map(img => `<img src="${img}" alt="客訴照片">`).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="complaint-actions">
                    ${complaint.status === 'pending' ? `<button class="btn btn-primary" onclick="updateStatus(${complaint.id}, 'processing')">開始處理</button>` : ''}
                    ${complaint.status === 'processing' ? `<button class="btn btn-primary" onclick="updateStatus(${complaint.id}, 'resolved')">標記為已解決</button>` : ''}
                    <button class="btn btn-danger" onclick="deleteComplaint(${complaint.id})">刪除</button>
                </div>
            `;
            
            return item;
        }

        // 更新狀態
        function updateStatus(id, status) {
            const complaint = complaints.find(c => c.id === id);
            if (complaint) {
                complaint.status = status;
                localStorage.setItem('complaints_backup', JSON.stringify(complaints));
                loadComplaintList();
                updateStats();
                
                // 可以在這裡加入更新 Google Sheets 的邏輯
                showMessage('info', '✅ 狀態已更新');
            }
        }

        // 刪除客訴
        function deleteComplaint(id) {
            if (confirm('確定要刪除這筆客訴記錄嗎？')) {
                complaints = complaints.filter(c => c.id !== id);
                localStorage.setItem('complaints_backup', JSON.stringify(complaints));
                loadComplaintList();
                updateStats();
                showMessage('info', '🗑️ 記錄已刪除');
            }
        }

        // 更新統計數據
        function updateStats() {
            if (!isAdminLoggedIn) return;
            
            const total = complaints.length;
            const pending = complaints.filter(c => c.status === 'pending').length;
            const processing = complaints.filter(c => c.status === 'processing').length;
            const resolved = complaints.filter(c => c.status === 'resolved').length;
            
            document.getElementById('total-complaints').textContent = total;
            document.getElementById('pending-complaints').textContent = pending;
            document.getElementById('processing-complaints').textContent = processing;
            document.getElementById('resolved-complaints').textContent = resolved;
        }

        // 輔助函數
        function getStatusText(status) {
            const statusMap = {
                'pending': '待處理',
                'processing': '處理中',
                'resolved': '已解決'
            };
            return statusMap[status] || status;
        }

        function getStatusValue(statusText) {
            const statusMap = {
                '待處理': 'pending',
                '處理中': 'processing',
                '已解決': 'resolved'
            };
            return statusMap[statusText] || 'pending';
        }

        function getComplaintTypeText(type) {
            const foundType = complaintTypes.find(t => t.value === type);
            return foundType ? foundType.label : type;
        }

        function getComplaintTypeValue(typeText) {
            const foundType = complaintTypes.find(t => t.label === typeText);
            return foundType ? foundType.value : 'other';
        }
    </script>
</body>
</html>
